<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tasks | HabitHero</title>
  <link rel="stylesheet" href="css/style.css">
  <link href="https://unpkg.com/@tabler/icons-webfont@latest/tabler-icons.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- Shared navbar + footer + global state -->
  <script src="js/navbar.js"></script>
  <script src="js/footer.js"></script>
  <script src="js/script.js"></script>

  <!-- Logout wiring -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn && typeof auth !== 'undefined') {
        logoutBtn.addEventListener('click', async () => {
          try {
            await auth.signOut();
            window.location.href = 'login.html';
          } catch (err) {
            console.error('Logout failed:', err);
          }
        });
      }
    });
  </script>
</head>

<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
  <custom-navbar></custom-navbar>

  <main class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Your Tasks</h1>
      <button id="add-task-btn"
              class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center">
        <i data-feather="plus" class="w-4 h-4 mr-2"></i>
        New Task
      </button>
    </div>

    <section class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4">
      <div id="tasks-empty"
           class="text-sm text-gray-500 dark:text-gray-400">
        You don't have any tasks yet. Click "New Task" to create one.
      </div>
      <div id="tasks-list" class="divide-y divide-gray-200 dark:divide-gray-700"></div>
    </section>
  </main>

  <!-- Add Task Modal -->
  <div id="add-task-modal"
       class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-40">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-md p-6">
      <h2 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">New Task</h2>
      <form id="task-form" class="space-y-4">
        <div>
          <label for="task-title" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
            Title
          </label>
          <input id="task-title" type="text" required
                 class="mt-1 w-full rounded-lg border border-gray-300 dark:border-gray-600
                        bg-white dark:bg-gray-700 px-3 py-2 text-gray-900 dark:text-white">
        </div>

        <div>
          <label for="task-due" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
            Due date (optional)
          </label>
          <input id="task-due" type="date"
                 class="mt-1 w-full rounded-lg border border-gray-300 dark:border-gray-600
                        bg-white dark:bg-gray-700 px-3 py-2 text-gray-900 dark:text-white">
        </div>

        <div>
          <label for="task-priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
            Priority
          </label>
          <select id="task-priority"
                  class="mt-1 w-full rounded-lg border border-gray-300 dark:border-gray-600
                         bg-white dark:bg-gray-700 px-3 py-2 text-gray-900 dark:text-white">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </div>

        <div class="flex justify-end gap-2 pt-2">
          <button type="button" id="cancel-task"
                  class="px-3 py-2 rounded-lg text-sm text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700">
            Cancel
          </button>
          <button type="submit"
                  class="px-4 py-2 rounded-lg text-sm font-medium bg-indigo-600 hover:bg-indigo-700 text-white">
            Save Task
          </button>
        </div>
      </form>
    </div>
  </div>

  <custom-footer></custom-footer>

  <script>
      function cleanupOldCompletedTasks() {
      const ONE_DAY_MS = 24 * 60 * 60 * 1000;
      const now = Date.now();

      state.tasks = (state.tasks || []).filter(task => {
        // keep if not completed
        if (!task.completed) return true;

        // if completed but no timestamp, keep (or you can choose to delete immediately)
        if (!task.completedAt) return true;

        // delete if completed more than 1 day ago
        const age = now - Number(task.completedAt);
        return age <= ONE_DAY_MS;
      });

      // persist cleaned tasks
      saveState();
    }

    document.addEventListener('DOMContentLoaded', () => {
    if (window.feather) feather.replace();

      const listEl = document.getElementById('tasks-list');
      const emptyEl = document.getElementById('tasks-empty');
      const modal = document.getElementById('add-task-modal');
      const addBtn = document.getElementById('add-task-btn');
      const cancelBtn = document.getElementById('cancel-task');
      const form = document.getElementById('task-form');

      function renderTasks() {
        listEl.innerHTML = '';
        const tasks = Array.isArray(state.tasks) ? state.tasks : [];

        if (tasks.length === 0) {
          emptyEl.classList.remove('hidden');
          return;
        }
        emptyEl.classList.add('hidden');

        tasks
          .slice()
          .sort((a, b) => (a.due || '').localeCompare(b.due || ''))
          .forEach(task => {
            const wrapper = document.createElement('div');
            wrapper.className = 'py-3 flex items-start justify-between gap-3';

            const main = document.createElement('div');
            main.className = 'flex items-start gap-3';

            const checkbox = document.createElement('button');
            checkbox.className =
              'mt-1 w-5 h-5 rounded-full border flex items-center justify-center ' +
              (task.completed
                ? 'bg-indigo-600 border-indigo-600'
                : 'border-gray-300 dark:border-gray-600');
            checkbox.dataset.id = task.id;
            checkbox.dataset.action = 'toggle-complete';
            checkbox.innerHTML = '<i data-feather="check" class="w-3 h-3 text-white"></i>';

            const textWrap = document.createElement('div');
            const title = document.createElement('p');
            title.className = 'font-medium text-gray-800 dark:text-white';
            title.textContent = task.title;
            if (task.completed) title.classList.add('line-through', 'text-gray-400');

            const meta = document.createElement('p');
            meta.className = 'text-xs text-gray-500 dark:text-gray-400';
            const parts = [];
            if (task.due) parts.push('Due ' + formatDate(task.due));
            if (task.priority) parts.push('Priority: ' + task.priority);
            meta.textContent = parts.join(' • ');

            textWrap.appendChild(title);
            if (parts.length) textWrap.appendChild(meta);

            main.appendChild(checkbox);
            main.appendChild(textWrap);

            wrapper.appendChild(main);

            // Actions (e.g., delete)
            const actions = document.createElement('div');
            actions.className = 'flex items-center gap-2';

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'text-xs text-red-500 hover:text-red-600';
            deleteBtn.dataset.id = task.id;
            deleteBtn.dataset.action = 'delete-task';
            deleteBtn.innerHTML = '<i data-feather="trash-2" class="w-4 h-4"></i>';

            actions.appendChild(deleteBtn);
            wrapper.appendChild(actions);

            listEl.appendChild(wrapper);
          });

        if (window.feather) feather.replace();
      }

      addBtn.addEventListener('click', () => {
        modal.classList.remove('hidden');
      });

      cancelBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
        form.reset();
      });

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const title = document.getElementById('task-title').value.trim();
        const due = document.getElementById('task-due').value || null;
        const priority = document.getElementById('task-priority').value || 'medium';

        if (!title) return;

        const newTask = {
          id: generateId(),
          title,
          due,
          priority,
          completed: false,
        };

        if (!Array.isArray(state.tasks)) state.tasks = [];
        state.tasks.push(newTask);
        saveState();

        form.reset();
        modal.classList.add('hidden');
        renderTasks();
      });
      const COIN_REWARD_BY_PRIORITY = {
        low: 5,
        medium: 10,
        high: 15,
      };

      listEl.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action="toggle-complete"]');
        if (!btn) return;

        const id = btn.dataset.id;
        const t = (state.tasks || []).find(task => String(task.id) === String(id));
        if (!t) return;

        // make sure coins is a number
        if (typeof state.coins !== 'number') {
          state.coins = Number(state.coins) || 0;
        }

        const priority = t.priority || 'medium';
        const coinsForThisTask = COIN_REWARD_BY_PRIORITY[priority] ?? 10;

        if (!t.completed) {
          t.completed = true;
          t.completedAt = Date.now();           // ← store completion time
          state.coins += coinsForThisTask;
        } else {
          t.completed = false;
          t.completedAt = null;                 // ← clear completion time
          state.coins = Math.max(0, state.coins - coinsForThisTask);
        }

        saveState();
        renderTasks();
      });
      cleanupOldCompletedTasks();
      renderTasks();
    });
  </script>
</body>
</html>