<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar | HabitHero</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://unpkg.com/@tabler/icons-webfont@latest/tabler-icons.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
    <!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<!-- Your firebase config -->
<script src="firebase-config.js"></script>

<!-- Navbar JS (if you have navbar.js injecting HTML) -->
<script src="js/navbar.js"></script>

<!-- Logout script -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const logoutBtn = document.getElementById("logout-btn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        try {
          await auth.signOut();
          window.location.href = "login.html";
        } catch (err) {
          console.error("Logout failed:", err);
        }
      });
    }
  });
</script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
<custom-navbar></custom-navbar>
    
    <main class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Calendar</h1>
            <button id="add-event-btn" class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-lg flex items-center">
                <i data-feather="plus" class="w-4 h-4 mr-2"></i> Add Event
            </button>
        </div>

        <!-- Calendar Container -->
        <div class="bg-white dark:bg-white-800 rounded-xl shadow-md p-6">
            <div id="calendar"></div>
        </div>

        <!-- Add Event Modal -->
        <div id="add-event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white">Add New Event</h2>
                    <button id="close-event-modal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                        <i data-feather="x"></i>
                    </button>
                </div>
                <form id="event-form">
                    <div class="mb-4">
                        <label for="event-title" class="block text-gray-700 dark:text-gray-300 mb-2">Event Title</label>
                        <input type="text" id="event-title" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-white" required>
                    </div>
                    <div class="mb-4">
                        <label for="event-start" class="block text-gray-700 dark:text-gray-300 mb-2">Start Date & Time</label>
                        <input type="datetime-local" id="event-start" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-white" required>
                    </div>
                    <div class="mb-4">
                        <label for="event-end" class="block text-gray-700 dark:text-gray-300 mb-2">End Date & Time</label>
                        <input type="datetime-local" id="event-end" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-white">
                    </div>
                    <div class="mb-4">
                        <label for="event-color" class="block text-gray-700 dark:text-gray-300 mb-2">Color</label>
                        <select id="event-color" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-white">
                            <option value="#6366f1">Primary</option>
                            <option value="#ec4899">Secondary</option>
                            <option value="#10b981">Green</option>
                            <option value="#f59e0b">Yellow</option>
                            <option value="#ef4444">Red</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-primary-500 hover:bg-primary-600 text-white py-2 rounded-lg">
                        Add Event
                    </button>
                </form>
            </div>
        </div>
    </main>

<custom-footer></custom-footer>

<!-- Shared footer + state helpers -->
<script src="js/footer.js"></script>
<script src="js/script.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    if (window.feather) feather.replace();

    // Make sure arrays exist
    if (!Array.isArray(state.events)) state.events = [];
    if (!Array.isArray(state.tasks))  state.tasks  = [];
    if (!Array.isArray(state.habits)) state.habits = [];

    const calendarEl = document.getElementById('calendar');
    if (!calendarEl || !window.FullCalendar) {
      console.error('Calendar element or FullCalendar missing');
      return;
    }

    // ---- Build combined events: custom + task due dates + daily habits ----
    function buildCalendarEvents() {
      const combined = [];

      // 1) Custom calendar events from state.events
      const baseEvents = Array.isArray(state.events) ? state.events : [];
      baseEvents.forEach(e => {
        combined.push({
          ...e,
          id: e.id,
          extendedProps: {
            ...(e.extendedProps || {}),
            sourceType: 'custom',
          },
        });
      });

      // 2) Tasks with due dates
      const tasks = Array.isArray(state.tasks) ? state.tasks : [];
      tasks.forEach(t => {
        if (!t.due) return;  // skip tasks with no due date

        combined.push({
          id: 'task-' + t.id,
          title: 'Task: ' + (t.title || 'Untitled task'),
          start: t.due,
          allDay: true,
          backgroundColor: t.completed ? '#10b981' : '#6366f1',  // green if done, indigo if pending
          borderColor:   t.completed ? '#10b981' : '#6366f1',
          extendedProps: {
            sourceType: 'task',
            priority: t.priority || 'medium',
            completed: !!t.completed,
          },
        });
      });

      // 3) Habits â€“ shown as daily recurring events
      const habits = Array.isArray(state.habits) ? state.habits : [];
      habits.forEach(h => {
        combined.push({
          id: 'habit-' + h.id,
          title: 'Habit: ' + (h.title || 'Untitled habit'),
          daysOfWeek: [0,1,2,3,4,5,6], // show every day
          allDay: true,
          backgroundColor: '#f59e0b',
          borderColor: '#f59e0b',
          extendedProps: {
            sourceType: 'habit',
          },
        });
      });

      return combined;
    }

    // ---- Init calendar ----
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      headerToolbar: {
        left:   'prev,next today',
        center: 'title',
        right:  'dayGridMonth,timeGridWeek,timeGridDay',
      },
      events: buildCalendarEvents(),
      eventClick(info) {
        const src = info.event.extendedProps.sourceType;

        // Only allow deleting custom calendar events, not tasks/habits
        if (src && src !== 'custom') return;

        if (confirm(`Delete event "${info.event.title}"?`)) {
          const id = info.event.id;
          state.events = (state.events || []).filter(
            e => String(e.id) !== String(id)
          );
          saveState();
          info.event.remove();
        }
      },
    });

    calendar.render();

    // ---- Modal + add event logic ----
    const addEventBtn   = document.getElementById('add-event-btn');
    const addEventModal = document.getElementById('add-event-modal');
    const closeEventBtn = document.getElementById('close-event-modal');
    const eventForm     = document.getElementById('event-form');

    if (!addEventBtn || !addEventModal || !closeEventBtn || !eventForm) return;

    addEventBtn.addEventListener('click', () => {
      addEventModal.classList.remove('hidden');
    });

    closeEventBtn.addEventListener('click', () => {
      addEventModal.classList.add('hidden');
    });

    eventForm.addEventListener('submit', (e) => {
      e.preventDefault();

      const title = document.getElementById('event-title').value;
      const start = document.getElementById('event-start').value;
      const end   = document.getElementById('event-end').value;
      const color = document.getElementById('event-color').value || '#6366f1';

      const newEvent = {
        id: generateId(),
        title,
        start,
        end: end || null,
        backgroundColor: color,
        borderColor: color,
        allDay: false,
      };

      if (!Array.isArray(state.events)) state.events = [];
      state.events.push(newEvent);
      saveState();

      // Add to calendar UI with sourceType so we can delete it later
      calendar.addEvent({
        ...newEvent,
        extendedProps: { sourceType: 'custom' },
      });

      eventForm.reset();
      addEventModal.classList.add('hidden');
    });
  });
</script>
</body>
</html>